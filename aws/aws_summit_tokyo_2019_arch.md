## クラウドにおけるアーキテクチャの設計原則
ちょい古いが見てみる
[動画](https://www.youtube.com/watch?v=FbnneJ17TA0)

## セッションの目的
- クラウドにおけるアーキテクチャの設計原則を見直す
- 実践して原則を理解する

## 基本中の基本

#### EC2の基礎
設定済みのバーチャルマシン(AMI)からネットワークストレージ(EBS)がアタッチされたVMを立ち上げるサービス

#### VPC
論理的に分離された環境でネットワークを構築
NACLがあったりセキュリティグループがあったり、NATを自分でアタッチしたりとセキュアなネットワークを構築できる

`Shared VPC`: VPC環境を複数アカウントで利用できる、ネットワークを管理するアカウントとサービスを管理するアカウントを分けれる。しらなかった。

↓ここからが本題↓
## 障害を見越した設計
- 冗長化
- 障害の検出
- 永続データストレージ
- 複数データセンタを用いた自動復旧

## 全レイヤでのセキュリティ実装
- 徹底的な防御
  - どこが防御されていないか把握できる状態を
- AWSのセキュリティサービスを積極使用
  - 使えるものは使おう
- 特権アクセス制限
  - 最小権限を
- リアルタイム監査

## ストレージの選択肢活用
- S3だけ使ってる人〜
- EC2ならEBS
- オンプレでFS使ってたらEFS
- Aurora,Dynamo,Elasticacheも選択肢に入る

## 伸縮性の実現
サービスはElasticに作ろう
- ブートストラッピング
  - 例えばEC2を立ち上げたときまっさらなVMに必要なもの(ユーザーデータ)を入れていく
- Golden Image
  - サービスで標準となるイメージを作成する
  - 伸縮できるように作る必要がある
- 家畜として扱う
  - サービスのコンポーネント１つ１つが入れ替え可能であるべき
- サービスの継続性
  - 冗長化

## 並列で考える
- 1台で１００時間　＝　１００台で１時間
  - 課金体系も１時間単位から秒単位になってるからもっと気軽にインスタンス立てよう
- なめらかなスケーリング
- 障害影響範囲を小さく
  - サービス同士の依存を最小限にする（疎結合にする）
- 並列を意識したソフトウェアを書く

## 疎結合はあなたを楽にする
- よいインターフェース定義
- サービスディスカバリ
  - 疎結合にした結果パーツが増えすぎたときにサービス同時の紐付けも考えるべき（考える価値がある）
  - SQSを使うだけでも疎結合簡単になる
    - SQSが最初のサービス！！
- 失敗時の適切な処理
  - 放置はいけない、やりなおすなどでも全然良い

## 制約を恐れない
- 制限するには理由がある
  - インスタンスの上限数などがある
- 提供できるものを計画する
  - 完璧を目指さない
- うまくいくものを出荷する
- できるときに出荷する
- 繰り返し繰り返す

## 実践
- ウェブアプリを作る
- セキュリティは常に最優先
  - どこからなにがくるかわからない
  - アカウント要不要、権限管理、証跡
    - IAMユーザー・グループの設定
      - おなじユーザーを使い回さない（当たり前）
      - 権限が同じだったらグループを使って、それぞれユーザーを使いましょう
    - CloudTrail,Config,GuardDuty,Security Hub, MFAの有効か
      - やすいので早い段階で入れましょう
    - Enabling and Disabling Region
      - 使うリージョンと使わないリージョンを決めたら使わないリージョンをDisableにしよう
    - control tower
      - 後で調べる
- 基本構成
  - ELB→EC2構成
  - 改善
    - セッション情報をEC2外に出す
      - DynamoDB,Redis
      - 書き換わっても良いならCookieも良い
    - Frontend　ServerとBackend Serverを分けて間にSQSを挟む
      - フロントの処理はサクッと終えて、重い処理はバックエンドに
    - 計算資源を使い捨てる
      - ブートストラッピング
        - cloud-initを使った環境構築
      - Golden Image
        - 特定の状態のスナップショット
      - コンテナ
        - Docker Image
      - IaCしよう
        - CloudFormation,OpsWorks
  - 外からの攻撃を考える
    - CF
      - S3への直接アクセス禁止
      - ALBのIPレンジ制限
    - WAF
      - サービスがいっぱいある？
        - Firewall Manager
    - Shield、ShieldAdvanced
      - CFだけでもL4のDDoSを回避できる
      - Shieldは無料なので入れて損はない
    - ３層入れよう
- Well-Architected Toolを見よう
  - 困ったら見る
  - 面倒だったらTrusted Advisor
    - ビジネスサポート以上で使える

## 総評
Trusted Advisorもっと有効活用しよ・・・。
